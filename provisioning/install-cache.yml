- name: Install
  hosts: cache
  tasks:
    - include_vars: vars.yml

    - name: Add debian sid repo
      apt_repository:
        repo: "{{ item }}"
        state: present
      with_items:
        - deb http://deb.debian.org/debian/ sid main
        - deb [trusted=yes] https://apt.fury.io/caddy/ /

    - name: Set default release
      copy:
        content: APT::Default-Release "stable";
        dest: /etc/apt/apt.conf.d/default-release

    - name: Install varnish, ufw
      apt:
        update_cache: yes
        pkg:
          - varnish
          - ufw

    - name: Install BIRD2 from sid
      apt:
        name: bird2
        default_release: sid

    - name: Copy BIRD2 config
      template:
        src: bird.j2
        dest: /etc/bird/bird.conf
      vars:
        asn: 34553
        selected_ipv4_prefix: "{{ cache_ipv4_prefix }}"
        selected_ipv6_prefix: "{{ cache_ipv6_prefix }}"
      register: bird_config

    - name: Apply BIRD config
      shell: birdc config
      when: bird_config.changed

    - name: Create network config
      copy:
        content: "{{ cache_config }}"
        dest: /root/network.sh
        mode: +x
      register: network_config

    - name: Apply network config
      shell: /root/network.sh
      when: network_config.changed

    - name: Copy Caddy unique config
      copy:
        content: |
          {
            experimental_http3
            admin {{ ansible_host }}:2019
          }

          (respond_metadata) {
            header PoP {{ ansible_hostname }}
          }
        dest: /etc/caddy/unique.conf

    - name: Copy firewall config
      template:
        src: ufw.j2
        dest: /root/ufw.sh
        mode: +x
      vars:
        allowed_hosts: "{{ allowed_hosts }}"

    - name: Copy varnish service
      template:
        src: varnish.service.j2
        dest: /lib/systemd/system/varnish.service
      register: varnish_config

    - name: Restart varnishd
      systemd:
        daemon_reload: yes
        name: varnish
        state: restarted
      when: varnish_config.changed
